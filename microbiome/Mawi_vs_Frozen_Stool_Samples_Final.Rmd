---
title: "Mawi vs. Frozen Stool Samples Final"
author: "Rigel Sison"
date: "1/18/2022"
output:
  pdf_document: default
  html_document: default
---

```{r message = FALSE}
# Load packages
necessary_packages <-  c("directlabels", "knitr", "clustsig", "ellipse", "phyloseq", "ggplot2", "plyr", "vegan", "reshape2", "ampvis2", "DESeq2", "gtable", "gridExtra", "grid", "Biostrings", "data.table", "labdsv", "ape", "multcompView")
packages <- lapply(necessary_packages, library, character.only = TRUE)
#("biomformat)
library(dplyr)
library(decontam)
library("RColorBrewer")
library("magrittr")
library("scales")
library("randomForest")
library(ggtern)
library(tidyr)
library(viridis)
library(cowplot)
library(tidyverse) # Easily Install and Load the 'Tidyverse'.
library(coin) # Conditional Inference Procedures in a Permutation Test Framework.
library(reshape2) # Flexibly Reshape Data: A Reboot of the Reshape Package.
library(ggnewscale)
library(VennDiagram)
library(gplots)
library(tibble)
source("a.diversity.anova.R")
```

## Loading Data
```{r}
table <- read.table(file = 'frozen_v_mawi.tsv', sep = '\t', header = TRUE)
copy <- table
rownames(copy) <- c(1:733)
rownames(copy)[1:9] <- paste0("00", rownames(copy)[1:9])
rownames(copy)[10:99] <- paste0("0", rownames(copy)[10:99])
rownames(copy) <- paste0("ST_", rownames(copy))
colnames(copy) <- gsub('MP_','', colnames(copy))
```

```{r}
final <- copy
st.phylo <- final[, 2:8]
st.counts <- final[, 9:74]
st.counts <- trunc(st.counts)
```

```{r}
st.counts.t <- t(st.counts)

map <- read.table("map_frozen_mawi.txt", header=TRUE, fill = TRUE)
map$Date <- as.POSIXct(map$Date,
                       format = "%Y-%m-%d")
rownames(map) <- map[,1]
map.samp <- map[,2:ncol(map)]
map.samp <- map.samp[rownames(st.counts.t),]

identical(rownames(st.counts.t),rownames(map))

st.phylo <- as.matrix(st.phylo)

class(st.counts.t) <- "numeric"

OTU <- otu_table(st.counts, taxa_are_rows = TRUE)
TAX <- tax_table(st.phylo)
META <- sample_data(map)
st.physeq <- phyloseq(OTU, TAX, META)
```

```{r}

sum(taxa_sums(st.physeq) == 0)
sum(taxa_sums(st.physeq) == 1) #7
sum(taxa_sums(st.physeq) == 2) #13
sum(taxa_sums(st.physeq) == 3) #11

st.physeq.f <- filter_taxa(st.physeq, function(x) sum(x > 3) > (0.02*length(x)), TRUE)

```

### Subset the phyloseq data by RNA and DNA

```{r message = FALSE}

st.physeq.dna <- subset_samples(st.physeq.f, Nucleic.Acid == "DNA")
st.physeq.rna <- subset_samples(st.physeq.f, Nucleic.Acid == "RNA")

day0 <- subset_samples(st.physeq.dna, Day = "0")
```

### Filter OTUs not present in both day 0 DNA sample across Mawi and Frozen
```{r message = FALSE}
library(MicrobiotaProcess)
vennlist <- get_vennlist(obj=day0, factorNames="Type")
ItemsList<- venn(vennlist, show.plot = FALSE)
intersections<- attributes(ItemsList)$intersections


detach("package:MicrobiotaProcess", unload = TRUE)

#filter OTUs not present in both day 0 samples across Mawi and Frozen
row.names.remove <- c(intersections$Mawi, intersections$Frozen)
copy.f <- copy[!(rownames(copy) %in% row.names.remove), ]
```

```{r}
final <- copy.f
st.phylo <- final[, 2:8]
st.counts <- final[, 9:74]
st.counts <- trunc(st.counts)

st.counts.t <- t(st.counts)

map <- read.table("map_frozen_mawi.txt", header=TRUE, fill = TRUE)
rownames(map) <- map[,1]
map.samp <- map[,2:ncol(map)]
map.samp <- map.samp[rownames(st.counts.t),]

identical(rownames(st.counts.t),rownames(map))

st.phylo <- as.matrix(st.phylo)

class(st.counts.t) <- "numeric"

OTU <- otu_table(st.counts, taxa_are_rows = TRUE)
TAX <- tax_table(st.phylo)
META <- sample_data(map)
st.physeq <- phyloseq(OTU, TAX, META)

sum(taxa_sums(st.physeq) == 0)
sum(taxa_sums(st.physeq) == 1) #7
sum(taxa_sums(st.physeq) == 2) #13
sum(taxa_sums(st.physeq) == 3) #11

st.physeq.f <- filter_taxa(st.physeq, function(x) sum(x > 3) > (0.02*length(x)), TRUE)


#Subset the phyloseq data by RNA and DNA


st.physeq.dna <- subset_samples(st.physeq.f, Nucleic.Acid == "DNA")
st.physeq.rna <- subset_samples(st.physeq.f, Nucleic.Acid == "RNA")
```

```{r message = FALSE}
set.seed(13)
#rarefy
st.physeq.fr <- rarefy_even_depth(st.physeq.f, sample.size = 280000, rngseed = TRUE)
st.physeq.dna.r <- rarefy_even_depth(st.physeq.dna, sample.size = 280000, rngseed = TRUE)

st.physeq.dna.r.mawi <- subset_samples(st.physeq.dna.r, Type == "Mawi")
st.physeq.dna.r.frozen <- subset_samples(st.physeq.dna.r, Type == "Frozen")
```

## Alpha diversity metrics (Chao1, Inverse Simpson, Shannon)
```{r}
sample_data(st.physeq.dna.r)$Day <- factor(sample_data(st.physeq.dna.r)$Day, levels = c("0", "3", "7", "14", "21", "40"))
sample_data(st.physeq.dna.r.mawi)$Day <- factor(sample_data(st.physeq.dna.r.mawi)$Day, levels = c("0", "3", "7", "14", "21", "40"))
sample_data(st.physeq.dna.r.frozen)$Day <- factor(sample_data(st.physeq.dna.r.frozen)$Day, levels = c("0", "3", "7", "14", "21", "40"))
```

```{r}
richness.dna <- estimate_richness(st.physeq.dna.r, split = TRUE, measures = c("Chao1", "InvSimpson", "Shannon"))

richness.dna.chao <- estimate_richness(st.physeq.dna.r, split = TRUE, measures = "Chao1")
richness.dna.chao$SampleID <- row.names(richness.dna.chao)
richness.dna.invs <- estimate_richness(st.physeq.dna.r, split = TRUE, measures = "InvSimpson")
richness.dna.invs$SampleID <- row.names(richness.dna.invs)
richness.dna.shannon <- estimate_richness(st.physeq.dna.r, split = TRUE, measures = "Shannon")
richness.dna.shannon$SampleID <- row.names(richness.dna.shannon)

write.csv(richness.dna, "richness_data.csv", row.names = TRUE)
```

```{r}
richness.dna.chao.plot <- plot_richness(st.physeq.dna.r,
                              measures = "Chao1",
                              x = "Day",
                              color = "Type",
                              shape = NA
                              ) +
  geom_boxplot() +
  coord_cartesian(ylim = c(0, 350)) +
  scale_color_manual(values = c('Frozen' = '#6BA7CC', 'Mawi' = '#ff6600')) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
richness.dna.chao$layers <- richness.dna.chao$layers[-1]
richness.dna.chao$layers <- richness.dna.chao$layers[-1]

richness.dna.invs.plot <- plot_richness(st.physeq.dna.r,
                              measures = "invsimpson",
                              x = "Day",
                              color = "Type",
                              shape = NA
                              ) +
  geom_boxplot() +
  geom_point(position = position_dodge(width = 0.75)) +
  coord_cartesian(ylim = c(0, 50)) +
  scale_color_manual(values = c('Frozen' = '#6BA7CC', 'Mawi' = '#ff6600')) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

richness.dna.shannon.plot <- plot_richness(st.physeq.dna.r,
                              measures = "Shannon",
                              x = "Day",
                              color = "Type",
                              shape = NA
                              ) +
  geom_boxplot() +
  scale_color_manual(values = c('Frozen' = '#6BA7CC', 'Mawi' = '#ff6600')) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

fit.shannon <- aov(Shannon ~ SampleID, data = richness.dna.shannon)
fit.chao <- aov(Chao1 ~ SampleID, data = richness.dna.chao)
fit.invs <- aov(InvSimpson ~ SampleID, data = richness.dna.invs)
```

```{r}
richness.dna.chao.plot
ggsave("richness_all_samples_dna_chao.pdf",
       width = 6,
       height = 4,
       units = "in")

richness.dna.invs.plot
ggsave("richness_all_samples_dna_invsimpson.pdf",
       width = 6,
       height = 4,
       units = "in")

richness.dna.shannon.plot
ggsave("richness_all_samples_dna_shannon.pdf",
       width = 6,
       height = 4,
       units = "in")
```
## ANOVA

```{r}
anova.mawi.plot <- plot_anova_diversity(st.physeq.dna.r.mawi, method = c("invsimpson", "shannon", "richness"), "Day")
anova.frozen.plot <- plot_anova_diversity(st.physeq.dna.r.frozen, c("invsimpson", "shannon", "richness"), "Day")

st.physeq.dna.r.mawi.t <- t(st.physeq.dna.r.mawi)
st.physeq.dna.r.frozen.t <- t(st.physeq.dna.r.frozen)

a_div <- alpha_div(physeq = st.physeq.dna.r.mawi.t, method = c("invsimpson", "shannon", "richness"))
meta_table <- sample_data(st.physeq.dna.r.mawi.t)

df <-data.frame(a_div,(meta_table[, "Day"])[as.character(a_div$sample),])
mawi.anova <- perform_anova(df,meta_table, "Day", 0.1)

a_div <- alpha_div(physeq = st.physeq.dna.r.frozen.t, method = c("invsimpson", "shannon", "richness"))
meta_table <- sample_data(st.physeq.dna.r.frozen.t)

df<-data.frame(a_div,(meta_table[, "Day"])[as.character(a_div$sample),])
frozen.anova <- perform_anova(df,meta_table, "Day", 0.1)

write.csv(mawi.anova$df_pw, "mawi_anova.csv", row.names = TRUE)
write.csv(frozen.anova$df_pw, "frozen_anova.csv", row.names = TRUE)
```

```{r}
anova.mawi.plot
ggsave("anova_mawi.pdf",
       width = 16,
       height = 9,
       units = "in")

anova.frozen.plot
ggsave("anova_frozen.pdf",
       width = 16,
       height = 9,
       units = "in")
```

## Community Composition

```{r message = FALSE}
library(MicrobiotaProcess)

genustaxa <- get_taxadf(obj=st.physeq.dna.r, taxlevel=6)
pgenus <- ggbartax(obj=genustaxa, facetNames="Type", topn = 30) +
  xlab(NULL) +
  ylab("relative abundance (%)") +
  scale_fill_manual(values = c(colorRampPalette(RColorBrewer::brewer.pal(12, "Set3"))(31))) +
  guides(fill = guide_legend(keywidth = 0.5, keyheight = 0.5)) +
  ggtitle("Genus Abundance By Sample") +
  theme(plot.title = element_text(hjust = 0.5, size = 20)) +
  theme(legend.text = element_text(size = 14)) + #5
  theme(axis.text.x = element_text(angle = 300, vjust = 1, size = 9)) #7

speciestaxa <- get_taxadf(obj=st.physeq.dna.r, taxlevel=7)
pspecies <- ggbartax(obj=speciestaxa, facetNames="Type", topn = 30) +
  xlab(NULL) +
  ylab("relative abundance (%)") +
  scale_fill_manual(values = c(colorRampPalette(RColorBrewer::brewer.pal(12, "Set3"))(31))) +
  guides(fill = guide_legend(keywidth = 0.5, keyheight = 0.5)) +
  ggtitle("Species Abundance By Sample") +
  theme(plot.title = element_text(hjust = 0.5, size = 20)) +
  theme(legend.text = element_text(size = 12)) + #4
  theme(axis.text.x = element_text(angle = 300, vjust = 1, size = 9)) #7
```

```{r}
pgenus
ggsave("ampvis_barchart_genus_top30.pdf",
       width = 16,
       height = 9,
       units = "in")


pspecies
ggsave("ampvis_barchart_species_top30.pdf",
       width = 16,
       height = 9,
       units = "in")
```

```{r}
detach("package:MicrobiotaProcess", unload = TRUE)
```

```{r}
obj <- st.physeq.dna.r
otutable <- data.frame(OTU = rownames(phyloseq::otu_table(obj)@.Data),
                       phyloseq::otu_table(obj)@.Data,
                       phyloseq::tax_table(obj)@.Data,
                       check.names = FALSE)

metadata <- data.frame(phyloseq::sample_data(obj),
                       check.names = FALSE)

my_ampvis2_object <- amp_load(otutable, metadata)

mawi_ampvis <- amp_subset_samples(my_ampvis2_object,
                                  Type %in% c("Mawi"),
                                  normalise = FALSE)

ampvis_day <- amp_heatmap(my_ampvis2_object,
                          group_by = "Type",
                          facet_by = "Day",
                          tax_aggregate = "Species",
                          tax_add = c("Phylum"),
                          tax_show = 30,
                          color_vector = c("white", "darkblue"),
                          plot_colorscale = "sqrt",
                          plot_values = TRUE,
                          plot_values_size = 2) +
  theme(axis.text.x = element_text(angle = 45, size = 14, vjust = 1),
        axis.text.y = element_text(size = 13),
        legend.position = "right") +
  ggtitle("Species Abundance By Sample Per Day") +
  theme(plot.title = element_text(hjust = 0.5, size = 20))
```

```{r}
ampvis_day
ggsave("ampvis_heatmap_by_day.pdf",
       width = 16,
       height = 9,
       units = "in")
```

```{r}
relative_abundance <- transform_sample_counts(st.physeq.dna.r, function(x) 100 * x/sum(x))
relative_abundance.phylum <- tax_glom(relative_abundance, "Phylum")
relative_abundance.family <- tax_glom(relative_abundance, "Family")
relative_abundance.genus <- tax_glom(relative_abundance, "Genus")

write.csv(tax_table(relative_abundance.phylum), "relative_abundance_phylum_tax.csv", row.names = TRUE)
write.csv(otu_table(relative_abundance.phylum), "relative_abundance_phylum_otu.csv", row.names = TRUE)

write.csv(tax_table(relative_abundance.family), "relative_abundance_family_tax.csv", row.names = TRUE)
write.csv(otu_table(relative_abundance.family), "relative_abundance_family_otu.csv", row.names = TRUE)

write.csv(tax_table(relative_abundance.genus), "relative_abundance_genus_tax.csv", row.names = TRUE)
write.csv(otu_table(relative_abundance.genus), "relative_abundance_genus_otu.csv", row.names = TRUE)
```

## Anosim (analysis of similarities)
```{r}
day0 <- subset_samples(st.physeq.dna.r, Day == 0)
day3 <- subset_samples(st.physeq.dna.r, Day == 3)
day7 <- subset_samples(st.physeq.dna.r, Day == 7)
day14 <- subset_samples(st.physeq.dna.r, Day == 14)
day21 <- subset_samples(st.physeq.dna.r, Day == 21)
day40 <- subset_samples(st.physeq.dna.r, Day == 40)

type_group0 <- get_variable(day0, "Type")
anosim.day0 <- anosim(phyloseq::distance(day0, "bray"), type_group0)
anosim.day0$signif #0.1
anosim.day0$statistic #0.3703704

type_group3 <- get_variable(day3, "Type")
anosim.day3 <- anosim(phyloseq::distance(day3, "bray"), type_group3)
anosim.day3$signif #0.1
anosim.day3$statistic #0.8518519

type_group7 <- get_variable(day7, "Type")
anosim.day7 <- anosim(phyloseq::distance(day7, "bray"), type_group7)
anosim.day7$signif #0.1
anosim.day7$statistic #0.962963

type_group14 <- get_variable(day14, "Type")
anosim.day14 <- anosim(phyloseq::distance(day14, "bray"), type_group14)
anosim.day14$signif #0.1
anosim.day14$statistic #0.3333333

type_group21 <- get_variable(day21, "Type")
anosim.day21 <- anosim(phyloseq::distance(day21, "bray"), type_group21)
anosim.day21$signif #0.1
anosim.day21$statistic #0.7777778

type_group40 <- get_variable(day40, "Type")
anosim.day40 <- anosim(phyloseq::distance(day40, "bray"), type_group40)
anosim.day40$signif #0.1
anosim.day40$statistic #1
```
```{r message = FALSE}

days <- c(0, 3, 7, 14, 21, 40)
pairs <- as.data.frame(combn(days, 2))

iter <- 1
all_stats <- list()

for (pair in pairs){
  
  val1 <- pairs[,iter][1]
  val2 <- pairs[,iter][2]
  
  subset <- subset_samples(st.physeq.dna.r.mawi, Day == val1 | Day == val2)
  var <- get_variable(subset, "Day")
  anosim <- anosim(phyloseq::distance(subset, "bray"), var)
  
  dat <- as.data.frame(anosim$statistic)
  dat$pair <- as.character(pairs[iter])
  
  all_stats[[iter]] <- dat
  
  iter <- iter + 1
}

mawi_stats <- do.call(rbind, all_stats)

iter <- 1
all_stats <- list()

for (pair in pairs){
  
  val1 <- pairs[,iter][1]
  val2 <- pairs[,iter][2]
  
  subset <- subset_samples(st.physeq.dna.r.frozen, Day == val1 | Day == val2)
  var <- get_variable(subset, "Day")
  anosim <- anosim(phyloseq::distance(subset, "bray"), var)
  
  dat <- as.data.frame(anosim$statistic)
  dat$pair <- as.character(pairs[iter])
  
  all_stats[[iter]] <- dat
  
  iter <- iter + 1
}

frozen_stats <- do.call(rbind, all_stats)
```
```{r}
mawi.anosim <- read_csv("mawi_anosim.csv")
mawi.anosim <- as.data.frame(mawi.anosim)

mawi.anosim$Var1 <- factor(mawi.anosim$Var1, levels = c("0", "3", "7", "14", "21", "40"))
mawi.anosim$Var2 <- factor(mawi.anosim$Var2, levels = c("0", "3", "7", "14", "21", "40"))
  
frozen.anosim <- read_csv("frozen_anosim.csv")
frozen.anosim <- as.data.frame(frozen.anosim)

frozen.anosim$Var1 <- factor(frozen.anosim$Var1, levels = c("0", "3", "7", "14", "21", "40"))
frozen.anosim$Var2 <- factor(frozen.anosim$Var2, levels = c("0", "3", "7", "14", "21", "40"))

rng <- range(mawi.anosim$value, frozen.anosim$value)

mawi.anosim.plot <- ggplot(mawi.anosim) +
  geom_tile(aes(x = Var1, y = Var2, fill = value)) +
  scale_fill_viridis(name="Temperature",
                     #midpoint = mean(rng),
                     breaks = seq(0, 1, 0.2),
                     limits = c(0, 1)) +
  geom_text(aes(x = Var1, y = Var2, label = round(value, 3)))

frozen.anosim.plot <- ggplot(frozen.anosim) +
  geom_tile(aes(x = Var1, y = Var2, fill = value)) +
  scale_fill_viridis(name="Temperature",
                     #midpoint = mean(rng),
                     breaks = seq(0, 1, 0.2),
                     limits = c(0, 1)) +  geom_text(aes(x = Var1, y = Var2, label = round(value, 3)))
```

```{r}
mawi.anosim.plot
ggsave("mawi_anosim_plot.pdf",
       width = 6,
       height = 4,
       units = "in")

frozen.anosim.plot
ggsave("frozen_anosim_plot.pdf",
       width = 6,
       height = 4,
       units = "in")
```

## Distance between T0 and other time points

### Remove faulty replicates
```{r message = FALSE}
filtered_reps <- subset_samples(st.physeq.dna, ID != "Frozen_DNA_D03_1" & ID != "Frozen_DNA_D03_3" & ID != "Mawi_DNA_D0_1" & ID != "Mawi_DNA_D03_1" & ID != "Mawi_DNA_D14_2" & ID != "Mawi_DNA_D21_1")

st.species <- tax_glom(filtered_reps, "Species")
species30 <- names(sort(taxa_sums(st.species), TRUE)[1:30])
speciesbot <- names(sort(taxa_sums(st.species), TRUE)[31: length(taxa_sums(st.species))])
st.species30 <- prune_taxa(species30, st.species)
st.speciesbot <- prune_taxa(speciesbot, st.species)

#rarefy for even depth
set.seed(13)
st.species30.r = rarefy_even_depth(st.species30, sample.size = 280000, rngseed = TRUE)
st.speciesbot.r = rarefy_even_depth(st.speciesbot, sample.size = 90000, rngseed = TRUE)
st.physeq.dna.r.filtered = rarefy_even_depth(filtered_reps, sample.size = 400000, rngseed = TRUE)
```

### Distances for only Top30 species
```{r}

# T0 vs T3, Mawi, species30

st.species30.t0_3.mawi <- subset_samples(st.species30.r, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '3')
dist.species30.t0_3.mawi <- phyloseq::distance(physeq = st.species30.t0_3.mawi, method = 'bray')
dist.species30.t0_3.mawi.df <- as.matrix(dist.species30.t0_3.mawi)
dist.species30.t0_3.mawi.list <- reshape2::melt(dist.species30.t0_3.mawi.df)[reshape2::melt(upper.tri(dist.species30.t0_3.mawi.df))$value,]
names(dist.species30.t0_3.mawi.list) <- c("c1", "c2", "distance")
dist.species30.t0_3.mawi.list <- cbind(dist.species30.t0_3.mawi.list, "comp" = "T0_vs_T03", "type" = "Mawi")

# T0 vs T7, Mawi, species30

st.species30.t0_7.mawi <- subset_samples(st.species30.r, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '7')
dist.species30.t0_7.mawi <- phyloseq::distance(physeq = st.species30.t0_7.mawi, method = 'bray')
dist.species30.t0_7.mawi.df <- as.matrix(dist.species30.t0_7.mawi)
dist.species30.t0_7.mawi.list <- reshape2::melt(dist.species30.t0_7.mawi.df)[reshape2::melt(upper.tri(dist.species30.t0_7.mawi.df))$value,]
names(dist.species30.t0_7.mawi.list) <- c("c1", "c2", "distance")
dist.species30.t0_7.mawi.list <- cbind(dist.species30.t0_7.mawi.list, "comp" = "T0_vs_T07", "type" = "Mawi")

# T0 vs T14, Mawi, species30

st.species30.t0_14.mawi <- subset_samples(st.species30.r, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '14')
dist.species30.t0_14.mawi <- phyloseq::distance(physeq = st.species30.t0_14.mawi, method = 'bray')
dist.species30.t0_14.mawi.df <- as.matrix(dist.species30.t0_14.mawi)
dist.species30.t0_14.mawi.list <- reshape2::melt(dist.species30.t0_14.mawi.df)[reshape2::melt(upper.tri(dist.species30.t0_14.mawi.df))$value,]
names(dist.species30.t0_14.mawi.list) <- c("c1", "c2", "distance")
dist.species30.t0_14.mawi.list <- cbind(dist.species30.t0_14.mawi.list, "comp" = "T0_vs_T14", "type" = "Mawi")

# T0 vs T21, Mawi, species30

st.species30.t0_21.mawi <- subset_samples(st.species30.r, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '21')
dist.species30.t0_21.mawi <- phyloseq::distance(physeq = st.species30.t0_21.mawi, method = 'bray')
dist.species30.t0_21.mawi.df <- as.matrix(dist.species30.t0_21.mawi)
dist.species30.t0_21.mawi.list <- reshape2::melt(dist.species30.t0_21.mawi.df)[reshape2::melt(upper.tri(dist.species30.t0_21.mawi.df))$value,]
names(dist.species30.t0_21.mawi.list) <- c("c1", "c2", "distance")
dist.species30.t0_21.mawi.list <- cbind(dist.species30.t0_21.mawi.list, "comp" = "T0_vs_T21", "type" = "Mawi")

# T0 vs T40, Mawi, species30

st.species30.t0_40.mawi <- subset_samples(st.species30.r, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '40')
dist.species30.t0_40.mawi <- phyloseq::distance(physeq = st.species30.t0_40.mawi, method = 'bray')
dist.species30.t0_40.mawi.df <- as.matrix(dist.species30.t0_40.mawi)
dist.species30.t0_40.mawi.list <- reshape2::melt(dist.species30.t0_40.mawi.df)[reshape2::melt(upper.tri(dist.species30.t0_40.mawi.df))$value,]
names(dist.species30.t0_40.mawi.list) <- c("c1", "c2", "distance")
dist.species30.t0_40.mawi.list <- cbind(dist.species30.t0_40.mawi.list, "comp" = "T0_vs_T40", "type" = "Mawi")

#combine all tables
dist.per.time_comp.species30.mawi <- rbind(dist.species30.t0_3.mawi.list, dist.species30.t0_7.mawi.list, dist.species30.t0_14.mawi.list, #dist.species30.t0_21.mawi.list, 
                                           dist.species30.t0_40.mawi.list)

#plot
boxplot.species30.mawi <- ggplot(dist.per.time_comp.species30.mawi, aes(x = comp, y = distance, fill = comp)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 8,
               outlier.size = 2) +
  scale_fill_viridis(discrete = TRUE, option = "plasma") + theme_bw() + theme(axis.title.x=element_blank(), legend.position = "none") +
  coord_cartesian(ylim = c(0, 0.27)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
```

```{r}

# T0 vs T3, Frozen, species30

st.species30.t0_3.frozen <- subset_samples(st.species30.r, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '3')
dist.species30.t0_3.frozen <- phyloseq::distance(physeq = st.species30.t0_3.frozen, method = 'bray')
dist.species30.t0_3.frozen.df <- as.matrix(dist.species30.t0_3.frozen)
dist.species30.t0_3.frozen.list <- reshape2::melt(dist.species30.t0_3.frozen.df)[reshape2::melt(upper.tri(dist.species30.t0_3.frozen.df))$value,]
names(dist.species30.t0_3.frozen.list) <- c("c1", "c2", "distance")
dist.species30.t0_3.frozen.list <- cbind(dist.species30.t0_3.frozen.list, "comp" = "T0_vs_T03", "type" = "Frozen")

# T0 vs T7, Frozen, species30

st.species30.t0_7.frozen <- subset_samples(st.species30.r, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '7')
dist.species30.t0_7.frozen <- phyloseq::distance(physeq = st.species30.t0_7.frozen, method = 'bray')
dist.species30.t0_7.frozen.df <- as.matrix(dist.species30.t0_7.frozen)
dist.species30.t0_7.frozen.list <- reshape2::melt(dist.species30.t0_7.frozen.df)[reshape2::melt(upper.tri(dist.species30.t0_7.frozen.df))$value,]
names(dist.species30.t0_7.frozen.list) <- c("c1", "c2", "distance")
dist.species30.t0_7.frozen.list <- cbind(dist.species30.t0_7.frozen.list, "comp" = "T0_vs_T07", "type" = "Frozen")

# T0 vs T14, Frozen, species30

st.species30.t0_14.frozen <- subset_samples(st.species30.r, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '14')
dist.species30.t0_14.frozen <- phyloseq::distance(physeq = st.species30.t0_14.frozen, method = 'bray')
dist.species30.t0_14.frozen.df <- as.matrix(dist.species30.t0_14.frozen)
dist.species30.t0_14.frozen.list <- reshape2::melt(dist.species30.t0_14.frozen.df)[reshape2::melt(upper.tri(dist.species30.t0_14.frozen.df))$value,]
names(dist.species30.t0_14.frozen.list) <- c("c1", "c2", "distance")
dist.species30.t0_14.frozen.list <- cbind(dist.species30.t0_14.frozen.list, "comp" = "T0_vs_T14", "type" = "Frozen")

# T0 vs T21, Frozen, species30

st.species30.t0_21.frozen <- subset_samples(st.species30.r, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '21')
dist.species30.t0_21.frozen <- phyloseq::distance(physeq = st.species30.t0_21.frozen, method = 'bray')
dist.species30.t0_21.frozen.df <- as.matrix(dist.species30.t0_21.frozen)
dist.species30.t0_21.frozen.list <- reshape2::melt(dist.species30.t0_21.frozen.df)[reshape2::melt(upper.tri(dist.species30.t0_21.frozen.df))$value,]
names(dist.species30.t0_21.frozen.list) <- c("c1", "c2", "distance")
dist.species30.t0_21.frozen.list <- cbind(dist.species30.t0_21.frozen.list, "comp" = "T0_vs_T21", "type" = "Frozen")

# T0 vs T40, Frozen, species30

st.species30.t0_40.frozen <- subset_samples(st.species30.r, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '40')
dist.species30.t0_40.frozen <- phyloseq::distance(physeq = st.species30.t0_40.frozen, method = 'bray')
dist.species30.t0_40.frozen.df <- as.matrix(dist.species30.t0_40.frozen)
dist.species30.t0_40.frozen.list <- reshape2::melt(dist.species30.t0_40.frozen.df)[reshape2::melt(upper.tri(dist.species30.t0_40.frozen.df))$value,]
names(dist.species30.t0_40.frozen.list) <- c("c1", "c2", "distance")
dist.species30.t0_40.frozen.list <- cbind(dist.species30.t0_40.frozen.list, "comp" = "T0_vs_T40", "type" = "Frozen")

#combine all tables
dist.per.time_comp.species30.frozen <- rbind(dist.species30.t0_3.frozen.list, dist.species30.t0_7.frozen.list, dist.species30.t0_14.frozen.list, #dist.species30.t0_21.frozen.list, 
                                             dist.species30.t0_40.frozen.list)

#plot
boxplot.species30.frozen <- ggplot(dist.per.time_comp.species30.frozen, aes(x = comp, y = distance, fill = comp)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 8,
               outlier.size = 2) +
  scale_fill_viridis(discrete = TRUE, option = "plasma") + theme_bw() + theme(axis.title.x=element_blank(), legend.position = "none") +
  coord_cartesian(ylim = c(0, 0.27)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
  
```

```{r}
dist.per.time_comp.species30 <- rbind(dist.per.time_comp.species30.frozen, dist.per.time_comp.species30.mawi)

boxplot.species30 <- ggplot(dist.per.time_comp.species30, aes(x = comp, y = distance, fill = comp, )) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 8,
               outlier.size = 2) +
  scale_fill_viridis(discrete = TRUE, option = "plasma") +
  facet_grid(. ~ type) +
  theme_bw() +
  theme(axis.title.x = element_blank(), legend.position = "none") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  ggtitle("Distance Across Time Points (Top 30 Species) (Bray-Curtis)") +
  theme(plot.title = element_text(hjust = 0.5))
```


```{r}
boxplot.species30
ggsave("boxplot_across_time_points (bray) (reps removed) (top 30).png",
       width = 16,
       height = 9,
       units = "in")
```

### Distances for all species not in Top 30
```{r}

# T0 vs T3, Mawi, speciesbot

st.speciesbot.t0_3.mawi <- subset_samples(st.speciesbot.r, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '3')
dist.speciesbot.t0_3.mawi <- phyloseq::distance(physeq = st.speciesbot.t0_3.mawi, method = 'bray')
dist.speciesbot.t0_3.mawi.df <- as.matrix(dist.speciesbot.t0_3.mawi)
dist.speciesbot.t0_3.mawi.list <- reshape2::melt(dist.speciesbot.t0_3.mawi.df)[reshape2::melt(upper.tri(dist.speciesbot.t0_3.mawi.df))$value,]
names(dist.speciesbot.t0_3.mawi.list) <- c("c1", "c2", "distance")
dist.speciesbot.t0_3.mawi.list <- cbind(dist.speciesbot.t0_3.mawi.list, "comp" = "T0_vs_T03", "type" = "Mawi")

# T0 vs T7, Mawi, speciesbot

st.speciesbot.t0_7.mawi <- subset_samples(st.speciesbot.r, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '7')
dist.speciesbot.t0_7.mawi <- phyloseq::distance(physeq = st.speciesbot.t0_7.mawi, method = 'bray')
dist.speciesbot.t0_7.mawi.df <- as.matrix(dist.speciesbot.t0_7.mawi)
dist.speciesbot.t0_7.mawi.list <- reshape2::melt(dist.speciesbot.t0_7.mawi.df)[reshape2::melt(upper.tri(dist.speciesbot.t0_7.mawi.df))$value,]
names(dist.speciesbot.t0_7.mawi.list) <- c("c1", "c2", "distance")
dist.speciesbot.t0_7.mawi.list <- cbind(dist.speciesbot.t0_7.mawi.list, "comp" = "T0_vs_T07", "type" = "Mawi")

# T0 vs T14, Mawi, speciesbot

st.speciesbot.t0_14.mawi <- subset_samples(st.speciesbot.r, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '14')
dist.speciesbot.t0_14.mawi <- phyloseq::distance(physeq = st.speciesbot.t0_14.mawi, method = 'bray')
dist.speciesbot.t0_14.mawi.df <- as.matrix(dist.speciesbot.t0_14.mawi)
dist.speciesbot.t0_14.mawi.list <- reshape2::melt(dist.speciesbot.t0_14.mawi.df)[reshape2::melt(upper.tri(dist.speciesbot.t0_14.mawi.df))$value,]
names(dist.speciesbot.t0_14.mawi.list) <- c("c1", "c2", "distance")
dist.speciesbot.t0_14.mawi.list <- cbind(dist.speciesbot.t0_14.mawi.list, "comp" = "T0_vs_T14", "type" = "Mawi")

# T0 vs T21, Mawi, speciesbot

st.speciesbot.t0_21.mawi <- subset_samples(st.speciesbot.r, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '21')
dist.speciesbot.t0_21.mawi <- phyloseq::distance(physeq = st.speciesbot.t0_21.mawi, method = 'bray')
dist.speciesbot.t0_21.mawi.df <- as.matrix(dist.speciesbot.t0_21.mawi)
dist.speciesbot.t0_21.mawi.list <- reshape2::melt(dist.speciesbot.t0_21.mawi.df)[reshape2::melt(upper.tri(dist.speciesbot.t0_21.mawi.df))$value,]
names(dist.speciesbot.t0_21.mawi.list) <- c("c1", "c2", "distance")
dist.speciesbot.t0_21.mawi.list <- cbind(dist.speciesbot.t0_21.mawi.list, "comp" = "T0_vs_T21", "type" = "Mawi")

# T0 vs T40, Mawi, speciesbot

st.speciesbot.t0_40.mawi <- subset_samples(st.speciesbot.r, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '40')
dist.speciesbot.t0_40.mawi <- phyloseq::distance(physeq = st.speciesbot.t0_40.mawi, method = 'bray')
dist.speciesbot.t0_40.mawi.df <- as.matrix(dist.speciesbot.t0_40.mawi)
dist.speciesbot.t0_40.mawi.list <- reshape2::melt(dist.speciesbot.t0_40.mawi.df)[reshape2::melt(upper.tri(dist.speciesbot.t0_40.mawi.df))$value,]
names(dist.speciesbot.t0_40.mawi.list) <- c("c1", "c2", "distance")
dist.speciesbot.t0_40.mawi.list <- cbind(dist.speciesbot.t0_40.mawi.list, "comp" = "T0_vs_T40", "type" = "Mawi")

#combine all tables
dist.per.time_comp.speciesbot.mawi <- rbind(dist.speciesbot.t0_3.mawi.list, dist.speciesbot.t0_7.mawi.list, dist.speciesbot.t0_14.mawi.list, #dist.speciesbot.t0_21.mawi.list, 
                                           dist.speciesbot.t0_40.mawi.list)

#plot
boxplot.speciesbot.mawi <- ggplot(dist.per.time_comp.speciesbot.mawi, aes(x = comp, y = distance, fill = comp)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 8,
               outlier.size = 2) +
  scale_fill_viridis(discrete = TRUE, option = "plasma") + theme_bw() + theme(axis.title.x=element_blank(), legend.position = "none") +
  coord_cartesian(ylim = c(0, 0.27)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
```

```{r}

# T0 vs T3, Frozen, speciesbot

st.speciesbot.t0_3.frozen <- subset_samples(st.speciesbot.r, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '3')
dist.speciesbot.t0_3.frozen <- phyloseq::distance(physeq = st.speciesbot.t0_3.frozen, method = 'bray')
dist.speciesbot.t0_3.frozen.df <- as.matrix(dist.speciesbot.t0_3.frozen)
dist.speciesbot.t0_3.frozen.list <- reshape2::melt(dist.speciesbot.t0_3.frozen.df)[reshape2::melt(upper.tri(dist.speciesbot.t0_3.frozen.df))$value,]
names(dist.speciesbot.t0_3.frozen.list) <- c("c1", "c2", "distance")
dist.speciesbot.t0_3.frozen.list <- cbind(dist.speciesbot.t0_3.frozen.list, "comp" = "T0_vs_T03", "type" = "Frozen")

# T0 vs T7, Frozen, speciesbot

st.speciesbot.t0_7.frozen <- subset_samples(st.speciesbot.r, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '7')
dist.speciesbot.t0_7.frozen <- phyloseq::distance(physeq = st.speciesbot.t0_7.frozen, method = 'bray')
dist.speciesbot.t0_7.frozen.df <- as.matrix(dist.speciesbot.t0_7.frozen)
dist.speciesbot.t0_7.frozen.list <- reshape2::melt(dist.speciesbot.t0_7.frozen.df)[reshape2::melt(upper.tri(dist.speciesbot.t0_7.frozen.df))$value,]
names(dist.speciesbot.t0_7.frozen.list) <- c("c1", "c2", "distance")
dist.speciesbot.t0_7.frozen.list <- cbind(dist.speciesbot.t0_7.frozen.list, "comp" = "T0_vs_T07", "type" = "Frozen")

# T0 vs T14, Frozen, speciesbot

st.speciesbot.t0_14.frozen <- subset_samples(st.speciesbot.r, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '14')
dist.speciesbot.t0_14.frozen <- phyloseq::distance(physeq = st.speciesbot.t0_14.frozen, method = 'bray')
dist.speciesbot.t0_14.frozen.df <- as.matrix(dist.speciesbot.t0_14.frozen)
dist.speciesbot.t0_14.frozen.list <- reshape2::melt(dist.speciesbot.t0_14.frozen.df)[reshape2::melt(upper.tri(dist.speciesbot.t0_14.frozen.df))$value,]
names(dist.speciesbot.t0_14.frozen.list) <- c("c1", "c2", "distance")
dist.speciesbot.t0_14.frozen.list <- cbind(dist.speciesbot.t0_14.frozen.list, "comp" = "T0_vs_T14", "type" = "Frozen")

# T0 vs T21, Frozen, speciesbot

st.speciesbot.t0_21.frozen <- subset_samples(st.speciesbot.r, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '21')
dist.speciesbot.t0_21.frozen <- phyloseq::distance(physeq = st.speciesbot.t0_21.frozen, method = 'bray')
dist.speciesbot.t0_21.frozen.df <- as.matrix(dist.speciesbot.t0_21.frozen)
dist.speciesbot.t0_21.frozen.list <- reshape2::melt(dist.speciesbot.t0_21.frozen.df)[reshape2::melt(upper.tri(dist.speciesbot.t0_21.frozen.df))$value,]
names(dist.speciesbot.t0_21.frozen.list) <- c("c1", "c2", "distance")
dist.speciesbot.t0_21.frozen.list <- cbind(dist.speciesbot.t0_21.frozen.list, "comp" = "T0_vs_T21", "type" = "Frozen")

# T0 vs T40, Frozen, speciesbot

st.speciesbot.t0_40.frozen <- subset_samples(st.speciesbot.r, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '40')
dist.speciesbot.t0_40.frozen <- phyloseq::distance(physeq = st.speciesbot.t0_40.frozen, method = 'bray')
dist.speciesbot.t0_40.frozen.df <- as.matrix(dist.speciesbot.t0_40.frozen)
dist.speciesbot.t0_40.frozen.list <- reshape2::melt(dist.speciesbot.t0_40.frozen.df)[reshape2::melt(upper.tri(dist.speciesbot.t0_40.frozen.df))$value,]
names(dist.speciesbot.t0_40.frozen.list) <- c("c1", "c2", "distance")
dist.speciesbot.t0_40.frozen.list <- cbind(dist.speciesbot.t0_40.frozen.list, "comp" = "T0_vs_T40", "type" = "Frozen")

#combine all tables
dist.per.time_comp.speciesbot.frozen <- rbind(dist.speciesbot.t0_3.frozen.list, dist.speciesbot.t0_7.frozen.list, dist.speciesbot.t0_14.frozen.list, #dist.speciesbot.t0_21.frozen.list, 
                                             dist.speciesbot.t0_40.frozen.list)

#plot
boxplot.speciesbot.frozen <- ggplot(dist.per.time_comp.speciesbot.frozen, aes(x = comp, y = distance, fill = comp)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 8,
               outlier.size = 2) +
  scale_fill_viridis(discrete = TRUE, option = "plasma") + theme_bw() + theme(axis.title.x=element_blank(), legend.position = "none") +
  coord_cartesian(ylim = c(0, 0.27)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
  
```

```{r}
dist.per.time_comp.speciesbot <- rbind(dist.per.time_comp.speciesbot.frozen, dist.per.time_comp.speciesbot.mawi)

boxplot.speciesbot <- ggplot(dist.per.time_comp.speciesbot, aes(x = comp, y = distance, fill = comp, )) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 8,
               outlier.size = 2) +
  scale_fill_viridis(discrete = TRUE, option = "plasma") +
  facet_grid(. ~ type) +
  theme_bw() +
  theme(axis.title.x = element_blank(), legend.position = "none") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  ggtitle("Distance Across Time Points (Excluding Top 30) (Bray-Curtis)") +
  theme(plot.title = element_text(hjust = 0.5))
```


```{r}
boxplot.speciesbot
ggsave("boxplot_across_time_points (bray) (reps removed) (not top 30).png",
       width = 16,
       height = 9,
       units = "in")
```

### Distances for all species
```{r}

# T0 vs T3, Mawi, physeq.dna

st.physeq.dna.t0_3.mawi <- subset_samples(st.physeq.dna.r.filtered, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '3')
dist.physeq.dna.t0_3.mawi <- phyloseq::distance(physeq = st.physeq.dna.t0_3.mawi, method = 'bray')
dist.physeq.dna.t0_3.mawi.df <- as.matrix(dist.physeq.dna.t0_3.mawi)
dist.physeq.dna.t0_3.mawi.list <- reshape2::melt(dist.physeq.dna.t0_3.mawi.df)[reshape2::melt(upper.tri(dist.physeq.dna.t0_3.mawi.df))$value,]
names(dist.physeq.dna.t0_3.mawi.list) <- c("c1", "c2", "distance")
dist.physeq.dna.t0_3.mawi.list <- cbind(dist.physeq.dna.t0_3.mawi.list, "comp" = "T0_vs_T03", "type" = "Mawi")

# T0 vs T7, Mawi, physeq.dna

st.physeq.dna.t0_7.mawi <- subset_samples(st.physeq.dna.r.filtered, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '7')
dist.physeq.dna.t0_7.mawi <- phyloseq::distance(physeq = st.physeq.dna.t0_7.mawi, method = 'bray')
dist.physeq.dna.t0_7.mawi.df <- as.matrix(dist.physeq.dna.t0_7.mawi)
dist.physeq.dna.t0_7.mawi.list <- reshape2::melt(dist.physeq.dna.t0_7.mawi.df)[reshape2::melt(upper.tri(dist.physeq.dna.t0_7.mawi.df))$value,]
names(dist.physeq.dna.t0_7.mawi.list) <- c("c1", "c2", "distance")
dist.physeq.dna.t0_7.mawi.list <- cbind(dist.physeq.dna.t0_7.mawi.list, "comp" = "T0_vs_T07", "type" = "Mawi")

# T0 vs T14, Mawi, physeq.dna

st.physeq.dna.t0_14.mawi <- subset_samples(st.physeq.dna.r.filtered, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '14')
dist.physeq.dna.t0_14.mawi <- phyloseq::distance(physeq = st.physeq.dna.t0_14.mawi, method = 'bray')
dist.physeq.dna.t0_14.mawi.df <- as.matrix(dist.physeq.dna.t0_14.mawi)
dist.physeq.dna.t0_14.mawi.list <- reshape2::melt(dist.physeq.dna.t0_14.mawi.df)[reshape2::melt(upper.tri(dist.physeq.dna.t0_14.mawi.df))$value,]
names(dist.physeq.dna.t0_14.mawi.list) <- c("c1", "c2", "distance")
dist.physeq.dna.t0_14.mawi.list <- cbind(dist.physeq.dna.t0_14.mawi.list, "comp" = "T0_vs_T14", "type" = "Mawi")

# T0 vs T21, Mawi, physeq.dna

st.physeq.dna.t0_21.mawi <- subset_samples(st.physeq.dna.r.filtered, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '21')
dist.physeq.dna.t0_21.mawi <- phyloseq::distance(physeq = st.physeq.dna.t0_21.mawi, method = 'bray')
dist.physeq.dna.t0_21.mawi.df <- as.matrix(dist.physeq.dna.t0_21.mawi)
dist.physeq.dna.t0_21.mawi.list <- reshape2::melt(dist.physeq.dna.t0_21.mawi.df)[reshape2::melt(upper.tri(dist.physeq.dna.t0_21.mawi.df))$value,]
names(dist.physeq.dna.t0_21.mawi.list) <- c("c1", "c2", "distance")
dist.physeq.dna.t0_21.mawi.list <- cbind(dist.physeq.dna.t0_21.mawi.list, "comp" = "T0_vs_T21", "type" = "Mawi")

# T0 vs T40, Mawi, physeq.dna

st.physeq.dna.t0_40.mawi <- subset_samples(st.physeq.dna.r.filtered, Type == 'Mawi' & Day == '0' | Type == 'Mawi' & Day == '40')
dist.physeq.dna.t0_40.mawi <- phyloseq::distance(physeq = st.physeq.dna.t0_40.mawi, method = 'bray')
dist.physeq.dna.t0_40.mawi.df <- as.matrix(dist.physeq.dna.t0_40.mawi)
dist.physeq.dna.t0_40.mawi.list <- reshape2::melt(dist.physeq.dna.t0_40.mawi.df)[reshape2::melt(upper.tri(dist.physeq.dna.t0_40.mawi.df))$value,]
names(dist.physeq.dna.t0_40.mawi.list) <- c("c1", "c2", "distance")
dist.physeq.dna.t0_40.mawi.list <- cbind(dist.physeq.dna.t0_40.mawi.list, "comp" = "T0_vs_T40", "type" = "Mawi")

#combine all tables
dist.per.time_comp.physeq.dna.mawi <- rbind(dist.physeq.dna.t0_3.mawi.list, dist.physeq.dna.t0_7.mawi.list, dist.physeq.dna.t0_14.mawi.list, #dist.physeq.dna.t0_21.mawi.list, 
                                           dist.physeq.dna.t0_40.mawi.list)

#plot
boxplot.physeq.dna.mawi <- ggplot(dist.per.time_comp.physeq.dna.mawi, aes(x = comp, y = distance, fill = comp)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 8,
               outlier.size = 2) +
  scale_fill_viridis(discrete = TRUE, option = "plasma") + theme_bw() + theme(axis.title.x=element_blank(), legend.position = "none") +
  coord_cartesian(ylim = c(0, 0.27)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
```

```{r}

# T0 vs T3, Frozen, physeq.dna

st.physeq.dna.t0_3.frozen <- subset_samples(st.physeq.dna.r.filtered, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '3')
dist.physeq.dna.t0_3.frozen <- phyloseq::distance(physeq = st.physeq.dna.t0_3.frozen, method = 'bray')
dist.physeq.dna.t0_3.frozen.df <- as.matrix(dist.physeq.dna.t0_3.frozen)
dist.physeq.dna.t0_3.frozen.list <- reshape2::melt(dist.physeq.dna.t0_3.frozen.df)[reshape2::melt(upper.tri(dist.physeq.dna.t0_3.frozen.df))$value,]
names(dist.physeq.dna.t0_3.frozen.list) <- c("c1", "c2", "distance")
dist.physeq.dna.t0_3.frozen.list <- cbind(dist.physeq.dna.t0_3.frozen.list, "comp" = "T0_vs_T03", "type" = "Frozen")

# T0 vs T7, Frozen, physeq.dna

st.physeq.dna.t0_7.frozen <- subset_samples(st.physeq.dna.r.filtered, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '7')
dist.physeq.dna.t0_7.frozen <- phyloseq::distance(physeq = st.physeq.dna.t0_7.frozen, method = 'bray')
dist.physeq.dna.t0_7.frozen.df <- as.matrix(dist.physeq.dna.t0_7.frozen)
dist.physeq.dna.t0_7.frozen.list <- reshape2::melt(dist.physeq.dna.t0_7.frozen.df)[reshape2::melt(upper.tri(dist.physeq.dna.t0_7.frozen.df))$value,]
names(dist.physeq.dna.t0_7.frozen.list) <- c("c1", "c2", "distance")
dist.physeq.dna.t0_7.frozen.list <- cbind(dist.physeq.dna.t0_7.frozen.list, "comp" = "T0_vs_T07", "type" = "Frozen")

# T0 vs T14, Frozen, physeq.dna

st.physeq.dna.t0_14.frozen <- subset_samples(st.physeq.dna.r.filtered, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '14')
dist.physeq.dna.t0_14.frozen <- phyloseq::distance(physeq = st.physeq.dna.t0_14.frozen, method = 'bray')
dist.physeq.dna.t0_14.frozen.df <- as.matrix(dist.physeq.dna.t0_14.frozen)
dist.physeq.dna.t0_14.frozen.list <- reshape2::melt(dist.physeq.dna.t0_14.frozen.df)[reshape2::melt(upper.tri(dist.physeq.dna.t0_14.frozen.df))$value,]
names(dist.physeq.dna.t0_14.frozen.list) <- c("c1", "c2", "distance")
dist.physeq.dna.t0_14.frozen.list <- cbind(dist.physeq.dna.t0_14.frozen.list, "comp" = "T0_vs_T14", "type" = "Frozen")

# T0 vs T21, Frozen, physeq.dna

st.physeq.dna.t0_21.frozen <- subset_samples(st.physeq.dna.r.filtered, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '21')
dist.physeq.dna.t0_21.frozen <- phyloseq::distance(physeq = st.physeq.dna.t0_21.frozen, method = 'bray')
dist.physeq.dna.t0_21.frozen.df <- as.matrix(dist.physeq.dna.t0_21.frozen)
dist.physeq.dna.t0_21.frozen.list <- reshape2::melt(dist.physeq.dna.t0_21.frozen.df)[reshape2::melt(upper.tri(dist.physeq.dna.t0_21.frozen.df))$value,]
names(dist.physeq.dna.t0_21.frozen.list) <- c("c1", "c2", "distance")
dist.physeq.dna.t0_21.frozen.list <- cbind(dist.physeq.dna.t0_21.frozen.list, "comp" = "T0_vs_T21", "type" = "Frozen")

# T0 vs T40, Frozen, physeq.dna

st.physeq.dna.t0_40.frozen <- subset_samples(st.physeq.dna.r.filtered, Type == 'Frozen' & Day == '0' | Type == 'Frozen' & Day == '40')
dist.physeq.dna.t0_40.frozen <- phyloseq::distance(physeq = st.physeq.dna.t0_40.frozen, method = 'bray')
dist.physeq.dna.t0_40.frozen.df <- as.matrix(dist.physeq.dna.t0_40.frozen)
dist.physeq.dna.t0_40.frozen.list <- reshape2::melt(dist.physeq.dna.t0_40.frozen.df)[reshape2::melt(upper.tri(dist.physeq.dna.t0_40.frozen.df))$value,]
names(dist.physeq.dna.t0_40.frozen.list) <- c("c1", "c2", "distance")
dist.physeq.dna.t0_40.frozen.list <- cbind(dist.physeq.dna.t0_40.frozen.list, "comp" = "T0_vs_T40", "type" = "Frozen")

#combine all tables
dist.per.time_comp.physeq.dna.frozen <- rbind(dist.physeq.dna.t0_3.frozen.list, dist.physeq.dna.t0_7.frozen.list, dist.physeq.dna.t0_14.frozen.list, #dist.physeq.dna.t0_21.frozen.list, 
                                             dist.physeq.dna.t0_40.frozen.list)

#plot
boxplot.physeq.dna.frozen <- ggplot(dist.per.time_comp.physeq.dna.frozen, aes(x = comp, y = distance, fill = comp)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 8,
               outlier.size = 2) +
  scale_fill_viridis(discrete = TRUE, option = "plasma") + theme_bw() + theme(axis.title.x=element_blank(), legend.position = "none") +
  coord_cartesian(ylim = c(0, 0.27)) +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
  
```

```{r}
dist.per.time_comp.physeq.dna <- rbind(dist.per.time_comp.physeq.dna.frozen, dist.per.time_comp.physeq.dna.mawi)

boxplot.physeq.dna <- ggplot(dist.per.time_comp.physeq.dna, aes(x = comp, y = distance, fill = comp, )) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 8,
               outlier.size = 2) +
  scale_fill_viridis(discrete = TRUE, option = "plasma") +
  facet_grid(. ~ type) +
  theme_bw() +
  theme(axis.title.x = element_blank(), legend.position = "none") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  ggtitle("Distance Across Time Points (All Species) (Bray-Curtis)") +
  theme(plot.title = element_text(hjust = 0.5))
```


```{r}
boxplot.physeq.dna
ggsave("boxplot_across_time_points (bray) (reps removed) (all).png",
       width = 16,
       height = 9,
       units = "in")

```

## NMDS (Bray-Curtis & Jaccard)

```{r}
# Ordinate
set.seed(13)
st.physeq.nmds.bray.dna <- ordinate(
  physeq = st.physeq.dna.r,
  method = 'NMDS',
  distance = 'bray'
)

bray_ord <- phyloseq::distance(physeq = st.physeq.dna.r, method = 'bray')

df_ord <- data.frame(sample_data(st.physeq.dna.r))
adonis(bray_ord ~ Type, data = df_ord)

beta <- betadisper(bray_ord, df_ord$Type)
permutest(beta)

nmds.bray.dna <- plot_ordination(
  physeq = st.physeq.dna.r,
  ordination <- st.physeq.nmds.bray.dna,
  color = 'Nucleic.Acid',
  title = 'nMDS of Bacterial Communities in Stool DNA Samples (Bray-Curtis)'
) +
  scale_color_manual(values = c('Frozen' = '#6BA7CC', 'Mawi' = '#ff6600')) +
  geom_point(aes(color = Type), size = 3) +
  theme(plot.title = element_text(hjust = 0.5)) +
  annotate("text", x = 0.2, y = 0.11, size = 3, label = "\n Stress=0.15\n Adonis\n R^2=0.12\n p=0.001")
```

```{r}
set.seed(13)
# Ordinate
st.physeq.nmds.jaccard.dna <- ordinate(
  physeq = st.physeq.dna.r,
  method = 'NMDS',
  distance = 'jaccard'
)

jaccard_ord <- phyloseq::distance(physeq = st.physeq.dna.r, method = 'jaccard')

df_ord <- data.frame(sample_data(st.physeq.dna.r))
adonis(jaccard_ord ~ Type, data = df_ord)

beta <- betadisper(jaccard_ord, df_ord$Type)
permutest(beta)

nmds.jaccard.dna <- plot_ordination(
  physeq = st.physeq.dna.r,
  ordination <- st.physeq.nmds.jaccard.dna,
  color = 'Nucleic.Acid',
  title = 'nMDS of Bacterial Communities in Stool DNA Samples (Jaccard)'
) +
  scale_color_manual(values = c('Frozen' = '#6BA7CC', 'Mawi' = '#ff6600')) +
  geom_point(aes(color = Type), size = 3) +
  theme(plot.title = element_text(hjust = 0.5)) +
  annotate("text", x = 0.30, y = 0.18, size = 3, label = "\n Stress=0.15\n Adonis\n R^2=0.12\n p=0.001")
  
```

```{r}
nmds.bray.dna
ggsave("nmds_bray_dna_all.pdf",
       width = 6.5,
       height = 4,
       units = "in")

nmds.jaccard.dna
ggsave("nmds_jaccard_dna_all.pdf",
       width = 6.5,
       height = 4,
       units = "in")
```
### Abundance Time Series
```{r message = FALSE}
#merged.day <- merge_samples(st.physeq.dna.r, "Day.Unique")


#obj <- merged.day
#otutable <- data.frame(OTU = rownames(phyloseq::otu_table(obj)@.Data),
                       #phyloseq::otu_table(obj)@.Data,
                       #phyloseq::tax_table(obj)@.Data,
                       #check.names = FALSE)

#metadata <- data.frame(phyloseq::sample_data(obj),
                       #check.names = FALSE)

#my_ampvis2_object_merged <- amp_load(otutable, metadata)

#amp_timeseries(my_ampvis2_object_merged,
  #time_variable = "Date",
  #group_by = "Type",
  #split = TRUE,
  #scales = "free_y",
  #tax_show = 12,
  #tax_aggregate = "Species"#,
  #tax_add = "Phylum"
#) +
  #scale_color_manual(values = c('Frozen' = '#6BA7CC', 'Mawi' = '#ff6600')) +
  #ggtitle("Relative Abundance Across Time") +
  #theme(plot.title = element_text(hjust = 0.5))

#ggsave("relative abundance time series.png",
 #      width = 16,
  #     height = 9,
   #    unit = "in")
```

## SIMPER analysis
```{r}
st.physeq.dna.r.abund <- as(otu_table(st.physeq.dna.r), "matrix")

if(taxa_are_rows(st.physeq.dna.r)){st.physeq.dna.r.abund <- t(st.physeq.dna.r.abund)}

st.physeq.dna.r.abund <- as.data.frame(st.physeq.dna.r.abund)

map_dna <- subset(map, Nucleic.Acid == "DNA")

type_simper <- simper(st.physeq.dna.r.abund, map_dna$Type, permutations = 100)

summary(type_simper)
```